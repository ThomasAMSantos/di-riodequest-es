<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro e Desempenho de Questões</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <script type="module">
        // Global variables for data
        let currentRecords = []; // Stores all fetched records
        let currentRevisions = []; // Stores all scheduled revisions
        let currentFilterMateria = 'todos'; // Current filter for materia
        let currentFilterAssunto = 'todos'; // Current filter for assunto
        let currentStartDate = ''; // Current filter for start date
        let currentEndDate = ''; // Current filter for end date
        let currentAccuracyThreshold = 70; // User-defined accuracy threshold for improvement areas
        
        // Default values for revision intervals - used for reset
        const defaultRevisionIntervals = [
            { minAccuracy: 0, maxAccuracy: 30, minDays: 1, maxDays: 3 },
            { minAccuracy: 30, maxAccuracy: 50, minDays: 3, maxDays: 7 },
            { minAccuracy: 50, maxAccuracy: 60, minDays: 7, maxDays: 15 },
            { minAccuracy: 60, maxAccuracy: 70, minDays: 15, maxDays: 30 },
            { minAccuracy: 70, maxAccuracy: 80, minDays: 30, maxDays: 60 },
            { minAccuracy: 80, maxAccuracy: 90, minDays: 60, maxDays: 90 },
            { minAccuracy: 90, maxAccuracy: 100, minDays: 90, maxDays: 120 }
        ];

        // Revision intervals, can be modified by the user
        let revisionIntervals = [...defaultRevisionIntervals];

        // Display settings, stored in localStorage
        let displaySettings = {
            showOverallSummary: true,
            showOverallAccuracyChart: true,
            showMateriaAccuracyChart: true,
            showAssuntoAccuracyChart: true,
            showTrendChart: true,
            showImprovementAreas: true,
            showAssuntoRevisions: true
        };

        // Comparison settings for the trend chart
        let comparisonSettings = {
            type: 'none', // 'none', 'materia', 'assunto'
            items: [] // Array of selected materia/assunto names for comparison
        };

        // Helper function to display messages
        const showMessage = (message, type = 'info') => {
            const statusMessage = document.getElementById('status-message');
            if (statusMessage) {
                statusMessage.textContent = message;
                statusMessage.className = 'p-4 mb-4 text-sm rounded-lg';
                if (type === 'success') {
                    statusMessage.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    statusMessage.classList.add('bg-red-100', 'text-red-800');
                } else if (type === 'warning') {
                    statusMessage.classList.add('bg-yellow-100', 'text-yellow-800');
                }
                statusMessage.classList.remove('hidden');
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 3000);
            } else {
                console.warn("Status message element not found.");
            }
        };

        // Function to save current records to localStorage
        const saveRecordsToLocalStorage = () => {
            try {
                localStorage.setItem('questionRecords', JSON.stringify(currentRecords));
                console.log("Dados salvos no localStorage.");
            } catch (e) {
                console.error("Erro ao salvar dados no localStorage:", e);
                showMessage('Erro ao salvar dados localmente.', 'error');
            }
        };

        // Function to save current revisions to localStorage
        const saveRevisionsToLocalStorage = () => {
            try {
                localStorage.setItem('scheduledRevisions', JSON.stringify(currentRevisions));
                console.log("Revisões salvas no localStorage.");
            } catch (e) {
                console.error("Erro ao salvar revisões no localStorage:", e);
            }
        };

        // Function to save revision intervals to localStorage
        const saveRevisionIntervals = () => {
            try {
                localStorage.setItem('revisionIntervals', JSON.stringify(revisionIntervals));
                console.log("Intervalos de revisão salvos no localStorage.");
            } catch (e) {
                console.error("Erro ao salvar intervalos de revisão:", e);
            }
        };

        // Função: Salvar configurações de exibição
        const saveDisplaySettings = () => {
            try {
                localStorage.setItem('displaySettings', JSON.stringify(displaySettings));
                console.log("Configurações de exibição salvas no localStorage.");
            } catch (e) {
                console.error("Erro ao salvar configurações de exibição:", e);
            }
        };

        // Função: Salvar configurações de comparação
        const saveComparisonSettings = () => {
            try {
                localStorage.setItem('comparisonSettings', JSON.stringify(comparisonSettings));
                console.log("Configurações de comparação salvas no localStorage.");
            } catch (e) {
                console.error("Erro ao salvar configurações de comparação:", e);
            }
        };


        // Function to load data from localStorage
        const loadQuestionData = () => {
            try {
                const storedRecords = localStorage.getItem('questionRecords');
                if (storedRecords) {
                    currentRecords = JSON.parse(storedRecords);
                    console.log("Dados de registro carregados:", currentRecords);
                } else {
                    currentRecords = [];
                    console.log("Nenhum registro encontrado.");
                }

                const storedRevisions = localStorage.getItem('scheduledRevisions');
                if (storedRevisions) {
                    currentRevisions = JSON.parse(storedRevisions);
                    console.log("Revisões agendadas carregadas:", currentRevisions);
                } else {
                    currentRevisions = [];
                    console.log("Nenhuma revisão agendada encontrada.");
                }

                const storedDisplaySettings = localStorage.getItem('displaySettings');
                if (storedDisplaySettings) {
                    displaySettings = { ...displaySettings, ...JSON.parse(storedDisplaySettings) };
                }
                
                const storedComparisonSettings = localStorage.getItem('comparisonSettings');
                if (storedComparisonSettings) {
                    comparisonSettings = { ...comparisonSettings, ...JSON.parse(storedComparisonSettings) };
                }

                const storedRevisionIntervals = localStorage.getItem('revisionIntervals');
                if (storedRevisionIntervals) {
                    revisionIntervals = JSON.parse(storedRevisionIntervals);
                }
            } catch (e) {
                console.error("Erro ao carregar dados:", e);
                showMessage('Erro ao carregar dados.', 'error');
                currentRecords = [];
                currentRevisions = [];
            }
        };

        // Function to add a new question record
        const addQuestionRecord = (record) => {
            record.id = Date.now().toString();
            currentRecords.push(record);
            saveRecordsToLocalStorage();
            updateRevisionSchedule(record.materia, record.assunto);
            showMessage('Registro adicionado com sucesso!', 'success');
            // Refresh UI
            updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
            populateRecordsTable(currentRecords);
            populateRevisionsTable(currentRevisions);
            populateMateriaFilter(currentRecords);
            populateAssuntoFilter(currentRecords);
            populateDatalists(currentRecords);
            populateComparisonSelectionButtons();
        };

        // Function to update an existing question record
        const updateQuestionRecord = (recordId, updatedData) => {
            const index = currentRecords.findIndex(record => record.id === recordId);
            if (index !== -1) {
                currentRecords[index] = { ...currentRecords[index], ...updatedData };
                saveRecordsToLocalStorage();
                updateRevisionSchedule(updatedData.materia, updatedData.assunto);
                showMessage('Registro atualizado com sucesso!', 'success');
                closeEditModal();
                // Refresh UI
                updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                populateRecordsTable(currentRecords);
                populateRevisionsTable(currentRevisions);
                populateMateriaFilter(currentRecords);
                populateAssuntoFilter(currentRecords);
                populateDatalists(currentRecords);
                populateComparisonSelectionButtons();
            } else {
                showMessage('Registro não encontrado para atualização.', 'error');
            }
        };
        
        // Function to delete a question record
        const deleteQuestionRecord = (recordId) => {
            showConfirmationModal('Tem certeza que deseja excluir este registro?', () => {
                const recordToDelete = currentRecords.find(record => record.id === recordId);
                if (recordToDelete) {
                    const { materia, assunto } = recordToDelete;
                    currentRecords = currentRecords.filter(record => record.id !== recordId);
                    saveRecordsToLocalStorage();
                    updateRevisionSchedule(materia, assunto); // Re-calculate revision for the subject
                    showMessage('Registro excluído com sucesso!', 'success');
                    // Refresh UI
                    updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                    populateRecordsTable(currentRecords);
                    populateRevisionsTable(currentRevisions);
                    populateMateriaFilter(currentRecords);
                    populateAssuntoFilter(currentRecords);
                    populateDatalists(currentRecords);
                    populateComparisonSelectionButtons();
                }
            });
        };

        // Function to handle the "Concluir" button for a revision
        window.openCompleteRevisionModal = (revisionId) => {
            const revision = currentRevisions.find(r => r.id === revisionId);
            if (revision) {
                const modal = document.getElementById('complete-revision-modal');
                const form = document.getElementById('complete-revision-form');
                const subjectSpan = document.getElementById('revision-subject-name');
                const revisionIdInput = document.getElementById('complete-revision-id');
                
                subjectSpan.textContent = `${revision.materia} - ${revision.assunto}`;
                revisionIdInput.value = revisionId;
                
                modal.classList.remove('hidden');
            }
        };

        // Function to close the "Concluir" revision modal
        window.closeCompleteRevisionModal = () => {
            const modal = document.getElementById('complete-revision-modal');
            const form = document.getElementById('complete-revision-form');
            if (modal) {
                modal.classList.add('hidden');
                form.reset();
            }
        };
        
        // Function to submit the "Concluir" revision form
        window.submitCompleteRevisionForm = (revisionId, quantidadeFeita, quantidadeAcertada) => {
            const revision = currentRevisions.find(r => r.id === revisionId);
            if (revision) {
                const newRecord = {
                    materia: revision.materia,
                    assunto: revision.assunto,
                    data: new Date().toISOString().slice(0, 10), // Use today's date for the new record
                    quantidadeFeita: quantidadeFeita,
                    quantidadeAcertada: quantidadeAcertada,
                    timestamp: new Date().toISOString()
                };
                
                // Add the new record and trigger the full UI refresh
                addQuestionRecord(newRecord);
                
                closeCompleteRevisionModal();
                showMessage(`Revisão de ${revision.assunto} concluída e registrada!`, 'success');
            }
        };
        
        // Function to handle the "Reagendar" button for a revision
        window.openRescheduleRevisionModal = (revisionId) => {
             const revision = currentRevisions.find(r => r.id === revisionId);
             if (revision) {
                 const modal = document.getElementById('reschedule-revision-modal');
                 const subjectSpan = document.getElementById('reschedule-subject-name');
                 const revisionIdInput = document.getElementById('reschedule-revision-id');
                 const dateInput = document.getElementById('reschedule-date');

                 subjectSpan.textContent = `${revision.materia} - ${revision.assunto}`;
                 revisionIdInput.value = revisionId;
                 dateInput.value = revision.nextReviewDate; // Pre-fill with the current next review date

                 modal.classList.remove('hidden');
             }
        };

        window.closeRescheduleRevisionModal = () => {
            const modal = document.getElementById('reschedule-revision-modal');
            const form = document.getElementById('reschedule-form');
            if (modal) {
                modal.classList.add('hidden');
                form.reset();
            }
        };

        window.submitRescheduleForm = (revisionId, newDate) => {
            const revision = currentRevisions.find(r => r.id === revisionId);
            if (revision) {
                revision.nextReviewDate = newDate;
                saveRevisionsToLocalStorage();
                populateRevisionsTable(currentRevisions);
                closeRescheduleRevisionModal();
                showMessage(`Revisão de ${revision.assunto} reagendada para ${newDate}.`, 'info');
            }
        };

        // Function to calculate and schedule the next revision
        const updateRevisionSchedule = (materia, assunto) => {
            const recordsForSubject = currentRecords.filter(r => r.materia.toLowerCase() === materia.toLowerCase() && r.assunto.toLowerCase() === assunto.toLowerCase());
            
            if (recordsForSubject.length === 0) {
                currentRevisions = currentRevisions.filter(r => !(r.materia.toLowerCase() === materia.toLowerCase() && r.assunto.toLowerCase() === assunto.toLowerCase()));
                saveRevisionsToLocalStorage();
                return;
            }

            // Calculate historical weighted accuracy
            let totalFeita = 0;
            let totalAcertada = 0;
            recordsForSubject.forEach(record => {
                totalFeita += record.quantidadeFeita;
                totalAcertada += record.quantidadeAcertada;
            });
            const cumulativeAccuracy = totalFeita > 0 ? (totalAcertada / totalFeita) * 100 : 0;

            let nextRevisionDate = null;
            let revisionDays = 0;

            const now = new Date();
            const lastReviewDate = new Date(recordsForSubject.sort((a,b) => new Date(b.data) - new Date(a.data))[0].data);

            // Find the appropriate interval based on cumulative accuracy
            let interval = revisionIntervals.find(i => cumulativeAccuracy >= i.minAccuracy && cumulativeAccuracy <= i.maxAccuracy);
            let defaultInterval = defaultRevisionIntervals.find(i => i.minAccuracy === interval.minAccuracy && i.maxAccuracy === interval.maxAccuracy);


            if (interval) {
                // Check if the current interval is the same as the default. If so, use minDays to avoid randomization.
                if (JSON.stringify(interval) === JSON.stringify(defaultInterval)) {
                    revisionDays = interval.minDays;
                } else {
                    // Generate a random number of days within the interval
                    revisionDays = Math.floor(Math.random() * (interval.maxDays - interval.minDays + 1)) + interval.minDays;
                }
                
                nextRevisionDate = new Date(lastReviewDate);
                nextRevisionDate.setDate(lastReviewDate.getDate() + revisionDays);
            } else {
                // Default to a small interval if no match is found
                nextRevisionDate = new Date(lastReviewDate);
                nextRevisionDate.setDate(lastReviewDate.getDate() + 1);
                revisionDays = 1;
            }
            
            const existingRevisionIndex = currentRevisions.findIndex(r => r.materia.toLowerCase() === materia.toLowerCase() && r.assunto.toLowerCase() === assunto.toLowerCase());

            const newRevision = {
                id: materia + '-' + assunto,
                materia: materia,
                assunto: assunto,
                lastReviewDate: lastReviewDate.toISOString().slice(0, 10),
                nextReviewDate: nextRevisionDate.toISOString().slice(0, 10),
                cumulativeAccuracy: cumulativeAccuracy,
                daysInterval: revisionDays
            };
            
            if (existingRevisionIndex !== -1) {
                currentRevisions[existingRevisionIndex] = newRevision;
            } else {
                currentRevisions.push(newRevision);
            }

            saveRevisionsToLocalStorage();
            populateRevisionsTable(currentRevisions);
        };
        
        // Function to populate the revisions table
        const populateRevisionsTable = (revisions) => {
            const tableBody = document.getElementById('revisions-table-body');
            const summaryLate = document.getElementById('summary-late');
            const summaryToday = document.getElementById('summary-today');
            const summaryUpcoming = document.getElementById('summary-upcoming');
            const lateRevisionsContainer = document.getElementById('late-revisions-container');

            if (!tableBody || !summaryLate || !summaryToday || !summaryUpcoming || !lateRevisionsContainer) return;

            tableBody.innerHTML = '';
            lateRevisionsContainer.innerHTML = '';

            const sortedRevisions = [...revisions].sort((a, b) => new Date(a.nextReviewDate) - new Date(b.nextReviewDate));

            let countLate = 0;
            let countToday = 0;
            let countUpcoming = 0;

            if (sortedRevisions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="py-3 px-6 text-center">Nenhuma revisão agendada.</td></tr>';
                lateRevisionsContainer.innerHTML = '<p class="text-gray-600 text-sm">Nenhuma revisão em atraso. Ótimo trabalho!</p>';
                summaryLate.textContent = 0;
                summaryToday.textContent = 0;
                summaryUpcoming.textContent = 0;
                return;
            }

            sortedRevisions.forEach(revision => {
                const row = tableBody.insertRow();
                const nextReviewDate = new Date(revision.nextReviewDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const timeDiff = nextReviewDate.getTime() - today.getTime();
                const daysRemaining = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                
                let dateDisplay = revision.nextReviewDate;
                let daysDisplay = '';
                let rowClass = 'bg-white hover:bg-gray-50';

                if (daysRemaining < 0) {
                    dateDisplay = `ATRASADA: ${revision.nextReviewDate}`;
                    daysDisplay = `${Math.abs(daysRemaining)} dias atrás`;
                    rowClass = 'bg-red-100 text-red-800 hover:bg-red-200';
                    countLate++;
                    
                    // Create card for late revision
                    const lateCard = document.createElement('div');
                    lateCard.className = `card p-4 rounded-lg shadow-sm border border-red-200 bg-red-50 flex flex-col justify-between`;
                    lateCard.innerHTML = `
                            <div>
                                <p class="text-lg font-bold text-red-800">${revision.materia.toUpperCase()}</p>
                                <p class="text-sm text-red-700">${revision.assunto.toUpperCase()}</p>
                                <p class="text-xs text-red-600 mt-2">Último acerto: ${revision.cumulativeAccuracy.toFixed(2)}%</p>
                                <p class="text-xs text-red-600">Revisão: ${Math.abs(daysRemaining)} dias atrás</p>
                            </div>
                            <div class="mt-4 flex space-x-2">
                                <button onclick="openCompleteRevisionModal('${revision.id}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded-md text-sm">Concluir</button>
                                <button onclick="openRescheduleRevisionModal('${revision.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded-md text-sm">Reagendar</button>
                            </div>
                    `;
                    lateRevisionsContainer.appendChild(lateCard);

                } else if (daysRemaining === 0) {
                    dateDisplay = `HOJE: ${revision.nextReviewDate}`;
                    daysDisplay = 'Hoje';
                    rowClass = 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200';
                    countToday++;
                } else {
                    dateDisplay = `Próxima: ${revision.nextReviewDate}`;
                    daysDisplay = `${daysRemaining} dias`;
                    rowClass = 'bg-blue-100 text-blue-800 hover:bg-blue-200';
                    countUpcoming++;
                }

                row.className = `text-gray-700 text-sm font-light ${rowClass}`;

                row.insertCell().textContent = revision.materia;
                row.insertCell().textContent = revision.assunto;
                row.insertCell().textContent = revision.lastReviewDate;
                row.insertCell().textContent = dateDisplay;
                row.insertCell().textContent = `${revision.cumulativeAccuracy.toFixed(2)}%`;

                const actionsCell = row.insertCell();
                actionsCell.className = 'text-center';
                const completeButton = document.createElement('button');
                completeButton.textContent = 'Concluir';
                completeButton.onclick = () => openCompleteRevisionModal(revision.id);
                completeButton.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white', 'font-bold', 'py-1', 'px-2', 'rounded-md', 'mr-2', 'text-sm');
                
                const rescheduleButton = document.createElement('button');
                rescheduleButton.textContent = 'Reagendar';
                rescheduleButton.onclick = () => openRescheduleRevisionModal(revision.id);
                rescheduleButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'font-bold', 'py-1', 'px-2', 'rounded-md', 'text-sm');

                actionsCell.appendChild(completeButton);
                actionsCell.appendChild(rescheduleButton);

            });
            
            // If no late revisions, show the default message
            if (countLate === 0) {
                lateRevisionsContainer.innerHTML = '<p class="text-gray-600 text-sm">Nenhuma revisão em atraso. Ótimo trabalho!</p>';
            }


            summaryLate.textContent = countLate;
            summaryToday.textContent = countToday;
            summaryUpcoming.textContent = countUpcoming;
        };

        // --- Chart.js instances ---
        let materiaChart;
        let assuntoChart;
        let overallChart;
        let comparisonTrendChart;

        // Function to update the performance display and graphs
        const updatePerformanceDisplay = (records, filterMateria = 'todos', filterAssunto = 'todos', startDate = '', endDate = '') => {
            const performanceSummary = document.getElementById('performance-summary');
            if (!performanceSummary) return;

            performanceSummary.innerHTML = '';

            let recordsForMainFilters = records;

            if (filterMateria !== 'todos') {
                recordsForMainFilters = recordsForMainFilters.filter(record => record.materia.toLowerCase() === filterMateria.toLowerCase());
            }
            if (filterAssunto !== 'todos') {
                recordsForMainFilters = recordsForMainFilters.filter(record => record.assunto.toLowerCase() === filterAssunto.toLowerCase());
            }
            if (startDate && endDate) {
                recordsForMainFilters = recordsForMainFilters.filter(record => {
                    const recordDate = new Date(record.data);
                    const start = new Date(startDate);
                    const end = new Date(new Date(endDate).setDate(new Date(endDate).getDate() + 1));
                    return recordDate >= start && recordDate < end;
                });
            } else if (startDate) {
                recordsForMainFilters = recordsForMainFilters.filter(record => {
                    const recordDate = new Date(record.data);
                    const start = new Date(startDate);
                    return recordDate >= start;
                });
            } else if (endDate) {
                recordsForMainFilters = recordsForMainFilters.filter(record => {
                    const recordDate = new Date(record.data);
                    const end = new Date(new Date(endDate).setDate(new Date(endDate).getDate() + 1));
                    return recordDate < end;
                });
            }

            let recordsForDisplay = recordsForMainFilters;
            if (comparisonSettings.type !== 'none' && comparisonSettings.items.length > 0) {
                if (comparisonSettings.type === 'materia') {
                    recordsForDisplay = recordsForMainFilters.filter(record =>
                        comparisonSettings.items.includes(record.materia.toLowerCase())
                    );
                } else if (comparisonSettings.type === 'assunto') {
                    recordsForDisplay = recordsForMainFilters.filter(record =>
                        comparisonSettings.items.includes(record.assunto.toLowerCase())
                    );
                }
            }

            if (recordsForDisplay.length === 0) {
                if (displaySettings.showOverallSummary) {
                    performanceSummary.innerHTML += `
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                            <h3 class="text-xl font-semibold text-blue-700 mb-2">Desempenho Geral</h3>
                            <p class="text-gray-600">Nenhum registro encontrado para os filtros atuais. Adicione questões ou ajuste os filtros.</p>
                            <p class="text-lg text-blue-800">Número de Revisões: <span class="font-bold">0</span></p>
                        </div>
                    `;
                }
                if (materiaChart) materiaChart.destroy();
                if (assuntoChart) assuntoChart.destroy();
                if (overallChart) overallChart.destroy();
                if (comparisonTrendChart) comparisonTrendChart.destroy();
                return;
            }

            let totalFeita = 0;
            let totalAcertada = 0;
            recordsForDisplay.forEach(record => {
                totalFeita += record.quantidadeFeita;
                totalAcertada += record.quantidadeAcertada;
            });
            const totalErros = totalFeita - totalAcertada;
            const overallAccuracy = totalFeita > 0 ? (totalAcertada / totalFeita) * 100 : 0;

            const performanceByMateria = {};
            const performanceByAssunto = {};

            recordsForDisplay.forEach(record => {
                const materia = record.materia.toLowerCase();
                const assunto = record.assunto.toLowerCase();

                if (!performanceByMateria[materia]) {
                    performanceByMateria[materia] = { feita: 0, acertada: 0 };
                }
                performanceByMateria[materia].feita += record.quantidadeFeita;
                performanceByMateria[materia].acertada += record.quantidadeAcertada;

                if (!performanceByAssunto[assunto]) {
                    performanceByAssunto[assunto] = { feita: 0, acertada: 0 };
                }
                performanceByAssunto[assunto].feita += record.quantidadeFeita;
                performanceByAssunto[assunto].acertada += record.quantidadeAcertada;
            });

            const materiaAccuracy = Object.entries(performanceByMateria).map(([materia, data]) => ({
                name: materia,
                accuracy: data.feita > 0 ? (data.acertada / data.feita) * 100 : 0,
                feita: data.feita,
                acertada: data.acertada,
                erros: data.feita - data.acertada
            }));

            const assuntoAccuracy = Object.entries(performanceByAssunto).map(([assunto, data]) => ({
                name: assunto,
                accuracy: data.feita > 0 ? (data.acertada / data.feita) * 100 : 0,
                feita: data.feita,
                acertada: data.acertada,
                erros: data.feita - data.acertada
            }));

            const materiasToImprove = materiaAccuracy.filter(m => m.accuracy < currentAccuracyThreshold).sort((a, b) => a.accuracy - b.accuracy);
            const assuntosToImprove = assuntoAccuracy.filter(a => a.accuracy < currentAccuracyThreshold).sort((a, b) => a.accuracy - b.accuracy);

            if (displaySettings.showOverallSummary) {
                performanceSummary.innerHTML += `
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                        <h3 class="text-xl font-semibold text-blue-700 mb-2">Desempenho Geral ${filterMateria !== 'todos' ? `em ${filterMateria.toUpperCase()}` : ''} ${filterAssunto !== 'todos' ? ` - Assunto: ${filterAssunto.toUpperCase()}` : ''}</h3>
                        <p class="text-lg text-blue-800">Total de Questões Feitas: <span class="font-bold">${totalFeita}</span></p>
                        <p class="text-lg text-blue-800">Total de Acertos: <span class="font-bold">${totalAcertada}</span></p>
                        <p class="text-lg text-blue-800">Total de Erros: <span class="font-bold">${totalErros}</span></p>
                        <p class="text-2xl font-bold text-blue-900">Precisão Geral: ${overallAccuracy.toFixed(2)}%</p>
                        <p class="text-lg text-blue-800">Número de Revisões: <span class="font-bold">${recordsForDisplay.length}</span></p>
                    </div>
                `;
            }

            if (displaySettings.showImprovementAreas && (materiasToImprove.length > 0 || assuntosToImprove.length > 0)) {
                performanceSummary.innerHTML += `
                    <div class="mb-6 p-4 bg-red-50 rounded-lg shadow-inner">
                        <h3 class="text-xl font-semibold text-red-700 mb-2">Áreas para Melhorar (Precisão < ${currentAccuracyThreshold}%)</h3>
                        ${materiasToImprove.length > 0 ? `
                        <h4 class="font-medium text-red-600 mt-3">Matérias:</h4>
                        <ul class="list-disc list-inside text-red-800">
                            ${materiasToImprove.map(m => `<li>${m.name.toUpperCase()}: ${m.accuracy.toFixed(2)}% (${m.feita} questões, ${m.acertada} acertos, ${m.erros} erros)</li>`).join('')}
                        </ul>
                        ` : ''}
                        ${assuntosToImprove.length > 0 ? `
                        <h4 class="font-medium text-red-600 mt-3">Assuntos:</h4>
                        <ul class="list-disc list-inside text-red-800">
                            ${assuntosToImprove.map(a => `<li>${a.name.toUpperCase()}: ${a.accuracy.toFixed(2)}% (${a.feita} questões, ${a.acertada} acertos, ${a.erros} erros)</li>`).join('')}
                        </ul>
                        ` : ''}
                    </div>
                `;
            } else if (displaySettings.showImprovementAreas) {
                    performanceSummary.innerHTML += `
                    <div class="mb-6 p-4 bg-green-50 rounded-lg shadow-inner">
                        <h3 class="text-xl font-semibold text-green-700 mb-2">Parabéns!</h3>
                        <p class="text-green-800">Sua precisão está excelente em todas as matérias e assuntos, ou acima do limite de ${currentAccuracyThreshold}%!</p>
                    </div>
                `;
            }


            renderCharts(overallAccuracy, materiaAccuracy, assuntoAccuracy, recordsForDisplay, recordsForMainFilters, filterMateria, filterAssunto);
        };

        const renderCharts = (overallAccuracy, materiaAccuracy, assuntoAccuracy, recordsForDisplay, recordsForMainFilters, filterMateria, filterAssunto) => {
            const overallCtx = document.getElementById('overallAccuracyChart');
            if (!overallCtx) { if (overallChart) overallChart.destroy(); const container = document.getElementById('overallAccuracyChartContainer'); if (container) container.classList.add('hidden'); return; }
            if (overallChart) overallChart.destroy();
            const overallChartContainer = document.getElementById('overallAccuracyChartContainer');
            if (overallChartContainer) overallChartContainer.classList.toggle('hidden', !displaySettings.showOverallAccuracyChart);
            if (displaySettings.showOverallAccuracyChart) {
                overallChart = new Chart(overallCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Acertos', 'Erros'],
                        datasets: [{
                            data: [overallAccuracy, 100 - overallAccuracy],
                            backgroundColor: ['#36A2EB', '#FF6384'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Precisão Geral',
                                font: { size: 18 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed !== null) { label += context.parsed.toFixed(2) + '%'; }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            const materiaCtx = document.getElementById('materiaAccuracyChart');
            if (!materiaCtx) { if (materiaChart) materiaChart.destroy(); const container = document.getElementById('materiaAccuracyChartContainer'); if (container) container.classList.add('hidden'); return; }
            if (materiaChart) materiaChart.destroy();
            const materiaChartContainer = document.getElementById('materiaAccuracyChartContainer');
            if (materiaChartContainer) materiaChartContainer.classList.toggle('hidden', !displaySettings.showMateriaAccuracyChart);
            if (displaySettings.showMateriaAccuracyChart) {
                materiaChart = new Chart(materiaCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: materiaAccuracy.map(m => m.name.toUpperCase()),
                        datasets: [{
                            label: 'Precisão (%)',
                            data: materiaAccuracy.map(m => m.accuracy),
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Precisão por Matéria',
                                font: { size: 18 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Precisão (%)'
                                }
                            }
                        }
                    }
                });
            }

            const assuntoCtx = document.getElementById('assuntoAccuracyChart');
            if (!assuntoCtx) { if (assuntoChart) assuntoChart.destroy(); const container = document.getElementById('assuntoAccuracyChartContainer'); if (container) container.classList.add('hidden'); return; }
            if (assuntoChart) assuntoChart.destroy();
            const assuntoChartContainer = document.getElementById('assuntoAccuracyChartContainer');
            if (assuntoChartContainer) assuntoChartContainer.classList.toggle('hidden', !displaySettings.showAssuntoAccuracyChart);
            if (displaySettings.showAssuntoAccuracyChart) {
                assuntoChart = new Chart(assuntoCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: assuntoAccuracy.map(a => a.name.toUpperCase()),
                        datasets: [{
                            label: 'Precisão (%)',
                            data: assuntoAccuracy.map(a => a.accuracy),
                            backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Precisão por Assunto',
                                font: { size: 18 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Precisão (%)'
                                }
                            }
                        }
                    }
                });
            }

            const trendCtx = document.getElementById('assuntoTrendChart');
            if (!trendCtx) { if (comparisonTrendChart) comparisonTrendChart.destroy(); const container = document.getElementById('assuntoTrendChartContainer'); if (container) container.classList.add('hidden'); return; }
            if (comparisonTrendChart) comparisonTrendChart.destroy();
            const trendChartContainer = document.getElementById('assuntoTrendChartContainer');
            if (trendChartContainer) trendChartContainer.classList.toggle('hidden', !displaySettings.showTrendChart);

            if (displaySettings.showTrendChart) {
                let trendLabels = [];
                let trendDatasets = [];
                let trendChartTitle = 'Evolução da Precisão';

                const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9900', '#C9CBCF', '#A3E635', '#F87171', '#60A5FA'];

                let recordsForTrendAggregation = recordsForMainFilters;

                if (comparisonSettings.type === 'materia' && comparisonSettings.items.length > 0) {
                    trendChartTitle = 'Evolução da Precisão por Matéria (Comparativo)';
                    recordsForTrendAggregation = recordsForMainFilters.filter(record =>
                        comparisonSettings.items.includes(record.materia.toLowerCase())
                    );
                } else if (comparisonSettings.type === 'assunto' && comparisonSettings.items.length > 0) {
                    trendChartTitle = 'Evolução da Precisão por Assunto (Comparativo)';
                    recordsForTrendAggregation = recordsForMainFilters.filter(record =>
                        comparisonSettings.items.includes(record.assunto.toLowerCase())
                    );
                } else {
                    if (filterAssunto !== 'todos') {
                        trendChartTitle = `Evolução da Precisão em ${filterAssunto.toUpperCase()}`;
                    } else if (filterMateria !== 'todos') {
                        trendChartTitle = `Evolução da Precisão por Assunto em ${filterMateria.toUpperCase()}`;
                    } else {
                        trendChartTitle = `Evolução da Precisão por Matéria`;
                    }
                }

                const aggregatedTrendData = {};

                recordsForTrendAggregation.forEach(record => {
                    let category = '';
                    if (comparisonSettings.type === 'materia' || (comparisonSettings.type === 'none' && filterAssunto === 'todos' && filterMateria === 'todos')) {
                        category = record.materia.toLowerCase();
                    } else if (comparisonSettings.type === 'assunto' || (comparisonSettings.type === 'none' && filterMateria !== 'todos' && filterAssunto === 'todos')) {
                        category = record.assunto.toLowerCase();
                    } else {
                        category = 'único';
                    }

                    if (!aggregatedTrendData[category]) {
                        aggregatedTrendData[category] = {};
                    }
                    if (!aggregatedTrendData[category][record.data]) {
                        aggregatedTrendData[category][record.data] = { feita: 0, acertada: 0 };
                    }
                    aggregatedTrendData[category][record.data].feita += record.quantidadeFeita;
                    aggregatedTrendData[category][record.data].acertada += record.quantidadeAcertada;
                });

                const allDates = new Set();
                Object.values(aggregatedTrendData).forEach(categoryData => {
                    Object.keys(categoryData).forEach(date => allDates.add(date));
                });
                trendLabels = Array.from(allDates).sort();

                let colorIndex = 0;
                Object.keys(aggregatedTrendData).forEach(category => {
                    const categoryData = aggregatedTrendData[category];
                    const dataPoints = trendLabels.map(date => {
                        const data = categoryData[date];
                        return data ? (data.acertada / data.feita) * 100 : null;
                    });

                    trendDatasets.push({
                        label: category.toUpperCase(),
                        data: dataPoints,
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length] + '33',
                        fill: false,
                        tension: 0.1,
                        spanGaps: true
                    });
                    colorIndex++;
                });

                if (trendDatasets.length > 0) {
                    comparisonTrendChart = new Chart(trendCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: trendLabels,
                            datasets: trendDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: trendChartTitle,
                                    font: { size: 18 }
                                },
                                annotation: {
                                    annotations: {
                                        line1: {
                                            type: 'line',
                                            yMin: currentAccuracyThreshold,
                                            yMax: currentAccuracyThreshold,
                                            borderColor: 'rgb(255, 99, 132)',
                                            borderWidth: 2,
                                            borderDash: [5, 5],
                                            label: {
                                                display: true,
                                                content: `Meta: ${currentAccuracyThreshold}%`,
                                                position: 'end'
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Precisão (%)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Data'
                                    }
                                }
                            }
                        }
                    });
                }
            }
        };

        const populateRecordsTable = (records) => {
            const tableBody = document.getElementById('records-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            records.forEach(record => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = record.materia;
                row.insertCell().textContent = record.assunto;
                row.insertCell().textContent = record.data;
                row.insertCell().textContent = record.quantidadeFeita;
                row.insertCell().textContent = record.quantidadeAcertada;

                const actionsCell = row.insertCell();
                const editButton = document.createElement('button');
                editButton.textContent = 'Editar';
                editButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white', 'font-bold', 'py-1', 'px-2', 'rounded-md', 'mr-2', 'text-sm');
                editButton.onclick = () => openEditModal(record);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Excluir';
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'font-bold', 'py-1', 'px-2', 'rounded-md', 'text-sm');
                deleteButton.onclick = () => deleteQuestionRecord(record.id);

                actionsCell.appendChild(editButton);
                actionsCell.appendChild(deleteButton);
            });
        };

        const populateMateriaFilter = (records) => {
            const materiaFilter = document.getElementById('materia-filter');
            if (!materiaFilter) return;
            const uniqueMaterias = new Set(records.map(record => record.materia));
            const sortedMaterias = Array.from(uniqueMaterias).sort((a,b) => a.localeCompare(b));

            materiaFilter.innerHTML = '<option value="todos">Todas as Matérias</option>';

            sortedMaterias.forEach(materia => {
                const option = document.createElement('option');
                option.value = materia;
                option.textContent = materia;
                materiaFilter.appendChild(option);
            });

            materiaFilter.value = currentFilterMateria;
        };

        const populateAssuntoFilter = (records) => {
            const assuntoFilter = document.getElementById('assunto-filter');
            if (!assuntoFilter) return;
            let recordsForAssuntoFilter = records;
            if (currentFilterMateria !== 'todos') {
                recordsForAssuntoFilter = records.filter(record => record.materia.toLowerCase() === currentFilterMateria.toLowerCase());
            }

            const uniqueAssuntos = new Set(recordsForAssuntoFilter.map(record => record.assunto));
            const sortedAssuntos = Array.from(uniqueAssuntos).sort((a,b) => a.localeCompare(b));

            assuntoFilter.innerHTML = '<option value="todos">Todos os Assuntos</option>';

            sortedAssuntos.forEach(assunto => {
                const option = document.createElement('option');
                option.value = assunto;
                option.textContent = assunto;
                assuntoFilter.appendChild(option);
            });

            assuntoFilter.value = currentFilterAssunto;
        };

        const populateDatalists = (records) => {
            const materiaDatalist = document.getElementById('materias-datalist');
            const assuntoDatalist = document.getElementById('assuntos-datalist');

            if (!materiaDatalist || !assuntoDatalist) return;

            materiaDatalist.innerHTML = '';
            assuntoDatalist.innerHTML = '';

            const uniqueMaterias = new Set(records.map(record => record.materia));
            const uniqueAssuntos = new Set(records.map(record => record.assunto));

            uniqueMaterias.forEach(materia => {
                const option = document.createElement('option');
                option.value = materia;
                option.textContent = materia;
                materiaDatalist.appendChild(option);
            });

            uniqueAssuntos.forEach(assunto => {
                const option = document.createElement('option');
                option.value = assunto;
                option.textContent = assunto;
                assuntoDatalist.appendChild(option);
            });
        };

        const populateComparisonSelectionButtons = () => {
            const comparisonButtonsContainer = document.getElementById('comparison-buttons-container');
            if (!comparisonButtonsContainer) return;

            comparisonButtonsContainer.innerHTML = '';

            let itemsToPopulate = [];
            if (comparisonSettings.type === 'materia') {
                itemsToPopulate = Array.from(new Set(currentRecords.map(record => record.materia)));
            } else if (comparisonSettings.type === 'assunto') {
                itemsToPopulate = Array.from(new Set(currentRecords.map(record => record.assunto)));
            }

            itemsToPopulate.sort((a, b) => a.localeCompare(b)).forEach(item => {
                const button = document.createElement('button');
                button.type = 'button';
                button.value = item.toLowerCase();
                button.textContent = item.toUpperCase();
                button.classList.add('px-4', 'py-2', 'rounded-full', 'border', 'text-sm', 'font-medium', 'transition-colors', 'duration-200');

                if (comparisonSettings.items.includes(item.toLowerCase())) {
                    button.classList.add('bg-blue-600', 'text-white', 'border-blue-600', 'hover:bg-blue-700');
                } else {
                    button.classList.add('bg-gray-200', 'text-gray-800', 'border-gray-300', 'hover:bg-gray-300');
                }

                button.addEventListener('click', () => {
                    const value = button.value;
                    const index = comparisonSettings.items.indexOf(value);
                    if (index > -1) {
                        comparisonSettings.items.splice(index, 1);
                    } else {
                        comparisonSettings.items.push(value);
                    }
                    saveComparisonSettings();
                    populateComparisonSelectionButtons();
                    updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                });
                comparisonButtonsContainer.appendChild(button);
            });
        };

        const updateComparisonOptionsVisibility = () => {
            const comparisonButtonsContainer = document.getElementById('comparison-buttons-container');
            if (comparisonButtonsContainer) {
                if (comparisonSettings.type === 'none') {
                    comparisonButtonsContainer.classList.add('hidden');
                } else {
                    comparisonButtonsContainer.classList.remove('hidden');
                    populateComparisonSelectionButtons();
                }
            }
        };

        const exportToCsv = (isAutomaticBackup = false) => {
            if (currentRecords.length === 0) {
                if (!isAutomaticBackup) { showMessage('Não há dados para exportar.', 'warning'); }
                return;
            }
            
            // Adicionando um novo campo 'revisionId' aos registros para rastrear revisões concluídas.
            const recordsWithRevisionStatus = currentRecords.map(record => {
                const recordForExport = { ...record };
                const revision = currentRevisions.find(r => 
                    r.materia.toLowerCase() === record.materia.toLowerCase() && 
                    r.assunto.toLowerCase() === record.assunto.toLowerCase()
                );
                recordForExport.nextReviewDate = revision ? revision.nextReviewDate : '';
                recordForExport.revisionStatus = 'N/A'; // Default status
                
                const recordDate = new Date(record.data);
                if (revision) {
                    const nextDate = new Date(revision.nextReviewDate);
                    // Checa se a data do registro é igual à data da próxima revisão
                    if (recordDate.toISOString().slice(0, 10) === nextDate.toISOString().slice(0, 10)) {
                        recordForExport.revisionStatus = 'Concluído';
                    } else {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        nextDate.setHours(0, 0, 0, 0);

                        const timeDiff = nextDate.getTime() - today.getTime();
                        const daysRemaining = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

                        if (daysRemaining < 0) {
                            recordForExport.revisionStatus = 'Atrasada';
                        } else if (daysRemaining === 0) {
                            recordForExport.revisionStatus = 'Hoje';
                        } else {
                            recordForExport.revisionStatus = 'Próxima';
                        }
                    }
                }
                
                return recordForExport;
            });

            const headers = ['Matéria', 'Assunto', 'Data', 'Quantidade Feita', 'Quantidade Acertada', 'Próxima Revisão', 'Status da Revisão'];
            
            const rows = recordsWithRevisionStatus.map(record => [
                record.materia,
                record.assunto,
                record.data,
                record.quantidadeFeita,
                record.quantidadeAcertada,
                record.nextReviewDate,
                record.revisionStatus
            ]);

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(field => {
                    const sanitizedField = String(field).includes(',') ? `"${String(field).replace(/"/g, '""')}"` : field;
                    return sanitizedField;
                }).join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                const filename = isAutomaticBackup ? `backup_questoes_${new Date().toISOString().slice(0,10)}.csv` : 'registros_questoes.csv';
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                if (!isAutomaticBackup) { showMessage('Dados exportados para CSV com sucesso!', 'success'); }
            } else {
                showMessage('Seu navegador não suporta a exportação direta para CSV.', 'error');
            }
            if (document.body.contains(link)) {
                document.body.removeChild(link);
            }
        };

        const importFromCsv = (event) => {
            const file = event.target.files[0];
            if (!file) { return; }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    showMessage('O arquivo CSV está vazio ou ilegível.', 'warning');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                // Atualizado para aceitar os novos cabeçalhos
                const expectedHeaders = ['Matéria', 'Assunto', 'Data', 'Quantidade Feita', 'Quantidade Acertada', 'Próxima Revisão', 'Status da Revisão'];

                if (headers.length < 5 || !['Matéria', 'Assunto', 'Data', 'Quantidade Feita', 'Quantidade Acertada'].every(h => headers.includes(h))) {
                    showMessage('Cabeçalhos CSV inválidos. Certifique-se de que o arquivo contém pelo menos: Matéria,Assunto,Data,Quantidade Feita,Quantidade Acertada', 'error');
                    return;
                }

                let importedRecords = [];
                let successCount = 0;
                let errorCount = 0;

                for (let i = 1; i < lines.length; i++) {
                    // Use a regex para dividir a linha, respeitando as aspas duplas
                    const values = lines[i].match(/(?:\"[^\"]*\"|[^,])+/g) || [];
                    const trimmedValues = values.map(v => v.trim().replace(/"/g, ''));

                    if (trimmedValues.length !== headers.length) {
                        console.warn(`Linha ignorada devido a formato incorreto: ${lines[i]}`);
                        errorCount++;
                        continue;
                    }

                    const record = {};
                    headers.forEach((header, index) => {
                        record[header.replace(/\s/g, '')] = trimmedValues[index];
                    });

                    const quantidadeFeita = parseInt(record.QuantidadeFeita);
                    const quantidadeAcertada = parseInt(record.QuantidadeAcertada);

                    if (isNaN(quantidadeFeita) || isNaN(quantidadeAcertada) || quantidadeAcertada > quantidadeFeita) {
                        console.warn(`Linha ignorada devido a dados numéricos inválidos ou inconsistentes: ${lines[i]}`);
                        errorCount++;
                        continue;
                    }
                    
                    // Não se importa com as novas colunas no import, apenas ignora
                    importedRecords.push({
                        id: Date.now().toString() + '-' + i,
                        materia: record.Matéria,
                        assunto: record.Assunto,
                        data: record.Data,
                        quantidadeFeita: quantidadeFeita,
                        quantidadeAcertada: quantidadeAcertada,
                        timestamp: new Date().toISOString()
                    });
                    successCount++;
                }

                if (importedRecords.length === 0 && errorCount > 0) {
                    showMessage(`Importação concluída: ${successCount} registros adicionados, ${errorCount} erros.`, 'warning');
                    return;
                } else if (importedRecords.length === 0) {
                    showMessage('Nenhum registro válido encontrado no arquivo CSV para importar.', 'warning');
                    return;
                }

                currentRecords = currentRecords.concat(importedRecords);
                saveRecordsToLocalStorage();
                importedRecords.forEach(r => updateRevisionSchedule(r.materia, r.assunto));
                
                showMessage(`Importação concluída: ${successCount} registros adicionados, ${errorCount} erros.`, 'info');
                loadQuestionData();
            };
            reader.readAsText(file);
        };

        const populateRevisionIntervals = () => {
            const intervalsContainer = document.getElementById('revision-intervals-container');
            if (!intervalsContainer) return;
            intervalsContainer.innerHTML = '';

            revisionIntervals.forEach((interval, index) => {
                const defaultInterval = defaultRevisionIntervals[index];
                let isModified = (interval.minDays !== defaultInterval.minDays || interval.maxDays !== defaultInterval.maxDays);
                let isDefaultClass = isModified ? '' : 'invisible';

                const intervalHtml = `
                    <div class="flex items-center space-x-2 my-2">
                        <span class="w-1/4 text-right text-sm text-gray-600">${interval.minAccuracy}% - ${interval.maxAccuracy}%:</span>
                        <input type="number" id="min-days-${index}" value="${interval.minDays}" class="form-input w-1/4 px-2 py-1 border rounded-md text-sm">
                        <span class="text-sm text-gray-600">-</span>
                        <input type="number" id="max-days-${index}" value="${interval.maxDays}" class="form-input w-1/4 px-2 py-1 border rounded-md text-sm">
                        <span class="text-sm text-gray-600">dias</span>
                        <button onclick="resetRevisionInterval(${index})" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-2 rounded-md text-sm ${isDefaultClass}">Reset</button>
                    </div>
                `;
                intervalsContainer.innerHTML += intervalHtml;
            });
            
            // Add event listeners to the newly created inputs.
            const inputs = intervalsContainer.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    const index = input.id.split('-').pop();
                    const minInput = document.getElementById(`min-days-${index}`);
                    const maxInput = document.getElementById(`max-days-${index}`);
                    const resetButton = input.closest('div').querySelector('button');

                    const isModified = (parseInt(minInput.value) !== defaultRevisionIntervals[index].minDays || 
                                         parseInt(maxInput.value) !== defaultRevisionIntervals[index].maxDays);

                    if (resetButton) {
                        if (isModified) {
                            resetButton.classList.remove('invisible');
                        } else {
                            resetButton.classList.add('invisible');
                        }
                    }
                    
                    updateRevisionIntervals();
                });
            });
        };
        
        // Function to reset a single revision interval to its default value
        window.resetRevisionInterval = (index) => {
            revisionIntervals[index] = { ...defaultRevisionIntervals[index] };
            saveRevisionIntervals();
            populateRevisionIntervals(); // Refresh the UI
            // Re-calculate all revisions based on the new intervals
            const uniqueSubjects = new Set(currentRecords.map(r => `${r.materia}|${r.assunto}`));
            uniqueSubjects.forEach(subject => {
                const [materia, assunto] = subject.split('|');
                updateRevisionSchedule(materia, assunto);
            });
            showMessage('Intervalo de revisão restaurado para o padrão!', 'success');
        };

        // Function to reset all revision intervals to their default values
        window.resetAllRevisionIntervals = () => {
            revisionIntervals = [...defaultRevisionIntervals];
            saveRevisionIntervals();
            populateRevisionIntervals();
            const uniqueSubjects = new Set(currentRecords.map(r => `${r.materia}|${r.assunto}`));
            uniqueSubjects.forEach(subject => {
                const [materia, assunto] = subject.split('|');
                updateRevisionSchedule(materia, assunto);
            });
            showMessage('Todos os intervalos de revisão restaurados para o padrão!', 'success');
        };

        const updateRevisionIntervals = () => {
            const newIntervals = [];
            const inputs = document.querySelectorAll('#revision-intervals-container input');
            
            for (let i = 0; i < inputs.length; i += 2) {
                const minDays = parseInt(inputs[i].value);
                const maxDays = parseInt(inputs[i+1].value);

                if (isNaN(minDays) || isNaN(maxDays) || minDays < 0 || maxDays < 0 || minDays > maxDays) {
                    // Do not revert or show a blocking alert. Just log a warning.
                    console.warn('Valores de intervalo de revisão inválidos detectados. A alteração não será salva.');
                    return;
                }
                newIntervals.push({
                    minAccuracy: revisionIntervals[i/2].minAccuracy,
                    maxAccuracy: revisionIntervals[i/2].maxAccuracy,
                    minDays: minDays,
                    maxDays: maxDays
                });
            }
            revisionIntervals = newIntervals;
            saveRevisionIntervals();
            // Re-calculate all revisions based on the new intervals
            const uniqueSubjects = new Set(currentRecords.map(r => `${r.materia}|${r.assunto}`));
            uniqueSubjects.forEach(subject => {
                const [materia, assunto] = subject.split('|');
                updateRevisionSchedule(materia, assunto);
            });
            showMessage('Intervalos de revisão atualizados com sucesso!', 'success');
        };

        const initializeDisplaySettingsCheckboxes = () => {
             document.querySelectorAll('#display-options-container input[type="checkbox"]').forEach(checkbox => {
                 if (checkbox) {
                     checkbox.checked = displaySettings[checkbox.id];
                     const parentLabel = checkbox.closest('label');
                     if (parentLabel) {
                         parentLabel.classList.toggle('bg-blue-100', checkbox.checked);
                         parentLabel.classList.toggle('border-blue-400', checkbox.checked);
                         parentLabel.classList.toggle('bg-gray-50', !checkbox.checked);
                         parentLabel.classList.toggle('border-gray-300', !checkbox.checked);
                     }
                 }
             });
        };
        
        const initializeComparisonSettings = () => {
             const compareTypeRadios = document.querySelectorAll('input[name="compare-type"]');
             compareTypeRadios.forEach(radio => {
                 if (radio.value === comparisonSettings.type) {
                     radio.checked = true;
                 }
             });
             updateComparisonOptionsVisibility();
             populateComparisonSelectionButtons();
        };

        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const editRecordId = document.getElementById('edit-record-id');
        const editMateria = document.getElementById('edit-materia');
        const editAssunto = document.getElementById('edit-assunto');
        const editData = document.getElementById('edit-data');
        const editQuantidadeFeita = document.getElementById('edit-quantidadeFeita');
        const editQuantidadeAcertada = document.getElementById('edit-quantidadeAcertada');
        const closeEditModalBtn = document.getElementById('close-edit-modal');

        const openEditModal = (record) => {
            if (!editModal || !editForm || !editRecordId || !editMateria || !editAssunto || !editData || !editQuantidadeFeita || !editQuantidadeAcertada) return;
            editRecordId.value = record.id;
            editMateria.value = record.materia;
            editAssunto.value = record.assunto;
            editData.value = record.data;
            editQuantidadeFeita.value = record.quantidadeFeita;
            editQuantidadeAcertada.value = record.quantidadeAcertada;
            editModal.classList.remove('hidden');
        };

        const closeEditModal = () => {
            if (editModal) editModal.classList.add('hidden');
        };

        if (editForm) {
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = editRecordId.value;
                const updatedData = {
                    materia: editMateria.value.trim(),
                    assunto: editAssunto.value.trim(),
                    data: editData.value,
                    quantidadeFeita: parseInt(editQuantidadeFeita.value),
                    quantidadeAcertada: parseInt(editQuantidadeAcertada.value)
                };

                if (updatedData.quantidadeAcertada > updatedData.quantidadeFeita) {
                    showMessage('Quantidade acertada não pode ser maior que a quantidade feita.', 'warning');
                    return;
                }

                updateQuestionRecord(id, updatedData);
            });
        }
        if (closeEditModalBtn) {
            closeEditModalBtn.addEventListener('click', closeEditModal);
        }

        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');
        let confirmAction = null;

        const showConfirmationModal = (message, onConfirm) => {
            if (!confirmationModal || !confirmationMessage) return;
            confirmationMessage.textContent = message;
            confirmAction = onConfirm;
            confirmationModal.classList.remove('hidden');
        };

        const closeConfirmationModal = () => {
            if (confirmationModal) confirmationModal.classList.add('hidden');
            confirmAction = null;
        };

        if (confirmYesBtn) {
            confirmYesBtn.addEventListener('click', () => {
                if (confirmAction) {
                    confirmAction();
                }
                closeConfirmationModal();
            });
        }
        if (confirmNoBtn) {
            confirmNoBtn.addEventListener('click', closeConfirmationModal);
        }

        window.openSettingsModal = () => {
            const settingsModal = document.getElementById('settings-modal');
            if (settingsModal) {
                settingsModal.classList.remove('hidden');
                populateMateriaFilter(currentRecords);
                populateAssuntoFilter(currentRecords);
                populateComparisonSelectionButtons();
            }
        };

        window.closeSettingsModal = () => {
            const settingsModal = document.getElementById('settings-modal');
            if (settingsModal) {
                settingsModal.classList.add('hidden');
                updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
            }
        };

        window.openRevisionSettingsModal = () => {
             const revisionSettingsModal = document.getElementById('revision-settings-modal');
             if (revisionSettingsModal) {
                 revisionSettingsModal.classList.remove('hidden');
                 populateRevisionIntervals();
             }
        };

        window.closeRevisionSettingsModal = () => {
            const revisionSettingsModal = document.getElementById('revision-settings-modal');
            if (revisionSettingsModal) {
                revisionSettingsModal.classList.add('hidden');
            }
        };
        
        // --- CÓDIGO DA SEÇÃO DE DOAÇÕES ---
        // Função para copiar texto para a área de transferência
        window.copyToClipboard = (elementId) => {
            const copyText = document.getElementById(elementId);
            if (!copyText) {
                showMessage('Elemento para copiar não encontrado.', 'error');
                return;
            }
            const textToCopy = copyText.value || copyText.textContent;
            
            // Usar document.execCommand para compatibilidade em iframes
            const tempInput = document.createElement('textarea');
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showMessage('Endereço copiado para a área de transferência!', 'success');
            } catch (err) {
                showMessage('Erro ao copiar. Por favor, copie manualmente.', 'warning');
                console.error('Falha ao copiar texto:', err);
            } finally {
                document.body.removeChild(tempInput);
            }
        };

        // Função para abrir a modal de doação
        window.openDonationModal = () => {
            const modal = document.getElementById('donation-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        };

        // Função para fechar a modal de doação
        window.closeDonationModal = () => {
            const modal = document.getElementById('donation-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };
        // --- FIM DO CÓDIGO DA SEÇÃO DE DOAÇÕES ---
        
        // --- NOVO CÓDIGO PARA OS BOTÕES DE CONTATO E SOBRE ---
        window.openContactModal = () => {
            const modal = document.getElementById('contact-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        };

        window.closeContactModal = () => {
            const modal = document.getElementById('contact-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        window.openAboutModal = () => {
            const modal = document.getElementById('about-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        };

        window.closeAboutModal = () => {
            const modal = document.getElementById('about-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Load data from local storage
            loadQuestionData();
            
            // Now that all data is loaded, initialize the UI
            initializeDisplaySettingsCheckboxes();
            initializeComparisonSettings();
            updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
            populateRecordsTable(currentRecords);
            populateRevisionsTable(currentRevisions);
            populateMateriaFilter(currentRecords);
            populateAssuntoFilter(currentRecords);
            populateDatalists(currentRecords);
            populateRevisionIntervals();

            if (currentRecords.length === 0) {
                showMessage('Bem-vindo! Seus dados serão salvos localmente. Mantenha-os em segurança com a função de exportar CSV.', 'info');
            }

            const showRegisterSectionBtn = document.getElementById('show-register-section');
            const showPerformanceSectionBtn = document.getElementById('show-performance-section');
            const showRevisionsSectionBtn = document.getElementById('show-revisions-section');
            const registroSection = document.getElementById('registro-section');
            const desempenhoSection = document.getElementById('desempenho-section');
            const revisoesSection = document.getElementById('revisoes-section');

            const allSections = [registroSection, desempenhoSection, revisoesSection];

            const hideAllSections = () => {
                allSections.forEach(section => section && section.classList.add('hidden'));
            };

            const showSection = (sectionToShow) => {
                hideAllSections();
                if (sectionToShow) sectionToShow.classList.remove('hidden');
            };

            if (showRegisterSectionBtn) {
                showRegisterSectionBtn.addEventListener('click', () => showSection(registroSection));
            }

            if (showPerformanceSectionBtn) {
                showPerformanceSectionBtn.addEventListener('click', () => {
                    showSection(desempenhoSection);
                    updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                    populateRecordsTable(currentRecords);
                });
            }
            
            if (showRevisionsSectionBtn) {
                showRevisionsSectionBtn.addEventListener('click', () => {
                    showSection(revisoesSection);
                    populateRevisionsTable(currentRevisions); // Ensure revisions are loaded when section is shown
                });
            }

            const questionForm = document.getElementById('question-form');
            if (questionForm) {
                questionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const materiaInput = document.getElementById('materia');
                    const assuntoInput = document.getElementById('assunto');
                    const dataInput = document.getElementById('data');
                    const quantidadeFeitaInput = document.getElementById('quantidadeFeita');
                    const quantidadeAcertadaInput = document.getElementById('quantidadeAcertada');

                    if (!materiaInput || !assuntoInput || !dataInput || !quantidadeFeitaInput || !quantidadeAcertadaInput) {
                        showMessage('Erro: Um ou mais campos do formulário não foram encontrados.', 'error');
                        return;
                    }

                    const materia = materiaInput.value.trim();
                    const assunto = assuntoInput.value.trim();
                    const data = dataInput.value;
                    const quantidadeFeita = parseInt(quantidadeFeitaInput.value);
                    const quantidadeAcertada = parseInt(quantidadeAcertadaInput.value);

                    if (!materia || !assunto || !data || isNaN(quantidadeFeita) || isNaN(quantidadeAcertada)) {
                        showMessage('Por favor, preencha todos os campos corretamente.', 'warning');
                        return;
                    }

                    if (quantidadeAcertada > quantidadeFeita) {
                        showMessage('Quantidade acertada não pode ser maior que a quantidade feita.', 'warning');
                        return;
                    }

                    const newRecord = {
                        materia: materia,
                        assunto: assunto,
                        data: data,
                        quantidadeFeita: quantidadeFeita,
                        quantidadeAcertada: quantidadeAcertada,
                        timestamp: new Date().toISOString()
                    };

                    addQuestionRecord(newRecord);
                    questionForm.reset();
                });
            }
            
            const completeRevisionForm = document.getElementById('complete-revision-form');
            if (completeRevisionForm) {
                completeRevisionForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const revisionId = document.getElementById('complete-revision-id').value;
                    const quantidadeFeita = parseInt(document.getElementById('revision-quantidadeFeita').value);
                    const quantidadeAcertada = parseInt(document.getElementById('revision-quantidadeAcertada').value);
                    
                    if (isNaN(quantidadeFeita) || isNaN(quantidadeAcertada) || quantidadeAcertada > quantidadeFeita) {
                        showMessage('Valores de questões inválidos. Verifique os números.', 'warning');
                        return;
                    }
                    
                    submitCompleteRevisionForm(revisionId, quantidadeFeita, quantidadeAcertada);
                });
            }
            
            const rescheduleForm = document.getElementById('reschedule-form');
            if (rescheduleForm) {
                rescheduleForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const revisionId = document.getElementById('reschedule-revision-id').value;
                    const newDate = document.getElementById('reschedule-date').value;

                    if (!newDate) {
                        showMessage('Por favor, selecione uma data válida.', 'warning');
                        return;
                    }

                    submitRescheduleForm(revisionId, newDate);
                });
            }

            const materiaFilter = document.getElementById('materia-filter');
            if (materiaFilter) {
                materiaFilter.addEventListener('change', (e) => {
                    currentFilterMateria = e.target.value;
                    currentFilterAssunto = 'todos';
                    const assuntoFilter = document.getElementById('assunto-filter');
                    if (assuntoFilter) assuntoFilter.value = 'todos';
                    populateAssuntoFilter(currentRecords);
                    updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                });
            }

            const assuntoFilter = document.getElementById('assunto-filter');
            if (assuntoFilter) {
                assuntoFilter.addEventListener('change', (e) => {
                    currentFilterAssunto = e.target.value;
                    updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                });
            }

            const startDateFilter = document.getElementById('start-date-filter');
            const endDateFilter = document.getElementById('end-date-filter');
            const resetDateFilterBtn = document.getElementById('reset-date-filter');

            if (startDateFilter) {
                startDateFilter.addEventListener('change', (e) => {
                    currentStartDate = e.target.value;
                    updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                });
            }
            if (endDateFilter) {
                endDateFilter.addEventListener('change', (e) => {
                    currentEndDate = e.target.value;
                    updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                });
            }
            if (resetDateFilterBtn && startDateFilter && endDateFilter) {
                resetDateFilterBtn.addEventListener('click', () => {
                    currentStartDate = '';
                    currentEndDate = '';
                    startDateFilter.value = '';
                    endDateFilter.value = '';
                    updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                });
            }

            const accuracyThresholdInput = document.getElementById('accuracy-threshold-input');
            if (accuracyThresholdInput) {
                accuracyThresholdInput.addEventListener('input', (e) => {
                    let value = parseInt(e.target.value);
                    if (isNaN(value) || value < 0) value = 0;
                    if (value > 100) value = 100;
                    currentAccuracyThreshold = value;
                    e.target.value = value;
                    updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                });
            }

            const exportCsvBtn = document.getElementById('export-csv-button');
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', () => exportToCsv(false));
            }

            const importCsvBtn = document.getElementById('import-csv-button');
            const csvFileInput = document.getElementById('csv-file-input');
            if (importCsvBtn && csvFileInput) {
                importCsvBtn.addEventListener('click', () => {
                    csvFileInput.click();
                });
                csvFileInput.addEventListener('change', importFromCsv);
            }

            const openSettingsModalBtn = document.getElementById('open-settings-modal');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal');

            if (openSettingsModalBtn) {
                openSettingsModalBtn.addEventListener('click', openSettingsModal);
            }
            if (closeSettingsModalBtn) {
                closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
            }

            const openRevisionSettingsBtn = document.getElementById('open-revision-settings');
            const closeRevisionSettingsBtn = document.getElementById('close-revision-settings');
            if (openRevisionSettingsBtn) {
                openRevisionSettingsBtn.addEventListener('click', openRevisionSettingsModal);
            }
            if (closeRevisionSettingsBtn) {
                closeRevisionSettingsBtn.addEventListener('click', closeRevisionSettingsModal);
            }


            document.querySelectorAll('#display-options-container input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    displaySettings[e.target.id] = e.target.checked;
                    saveDisplaySettings();
                    initializeDisplaySettingsCheckboxes();
                    updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                });
            });

            document.querySelectorAll('input[name="compare-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    comparisonSettings.type = e.target.value;
                    comparisonSettings.items = [];
                    saveComparisonSettings();
                    updateComparisonOptionsVisibility();
                    updatePerformanceDisplay(currentRecords, currentFilterMateria, currentFilterAssunto, currentStartDate, currentEndDate);
                });
            });


            if (registroSection && desempenhoSection && revisoesSection) {
                registroSection.classList.remove('hidden');
                desempenhoSection.classList.add('hidden');
                revisoesSection.classList.add('hidden');
            }
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 2rem;
        }
        .form-input, .form-button, .filter-select {
            border-radius: 0.5rem;
        }
        .form-button {
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .form-button:hover {
            transform: translateY(-2px);
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-bottom: 2rem;
        }
        /* Estilos para o overlay da modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* Estilos para o conteúdo da modal */
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 700px; /* Aumentei o max-width para dar mais espaço */
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        .comparison-item-button {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border-width: 1px;
            font-size: 0.875rem;
            font-weight: 500;
            transition-property: color, background-color, border-color, transform;
            transition-duration: 200ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        .comparison-item-button.selected {
            background-color: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
        }
        .comparison-item-button.selected:hover {
            background-color: #1d4ed8;
        }
        .comparison-item-button:not(.selected) {
            background-color: #e5e7eb;
            color: #374151;
            border-color: #d1d5db;
        }
        .comparison-item-button:not(.selected):hover {
            background-color: #d1d5db;
        }
        /* Estilos para o cabeçalho em telas pequenas */
        @media (max-width: 640px) {
            .header-buttons {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }
            .header-buttons button {
                width: 100%;
            }
        }
        /* Novo estilo para listas numeradas e com ícones */
        .styled-list li {
            position: relative;
            padding-left: 2rem; /* Espaço para o ícone */
        }

        .styled-list li::before {
            content: '✓'; /* Ícone de check */
            position: absolute;
            left: 0;
            top: 0;
            color: #10B981; /* Cor verde para o ícone */
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 shadow-lg rounded-b-xl">
        <div class="container flex justify-between items-center flex-wrap">
            <h1 class="text-3xl font-bold mb-4 sm:mb-0">Registro e Desempenho de Questões</h1>
            <!-- Botões de navegação e doação em uma única linha responsiva -->
            <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap header-buttons mt-4 sm:mt-0">
                <button id="show-register-section" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-2 px-3 sm:px-4 rounded-lg shadow-md text-sm sm:text-base">
                    Registrar
                </button>
                <button id="show-performance-section" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-2 px-3 sm:px-4 rounded-lg shadow-md text-sm sm:text-base">
                    Desempenho
                </button>
                <button id="show-revisions-section" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-2 px-3 sm:px-4 rounded-lg shadow-md text-sm sm:text-base">
                    Revisões
                </button>
                <button onclick="openAboutModal()" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-2 px-3 sm:px-4 rounded-lg shadow-md text-sm sm:text-base">
                    Sobre
                </button>
                <button onclick="openContactModal()" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-2 px-3 sm:px-4 rounded-lg shadow-md text-sm sm:text-base">
                    Contatos
                </button>
                <button onclick="openDonationModal()" class="form-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">
                    Apoie o Projeto
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <div id="status-message" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

        <div id="registro-section" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 card">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Registrar Nova Questão</h2>
                <form id="question-form" class="space-y-4">
                    <div>
                        <label for="materia" class="block text-sm font-medium text-gray-700 mb-1">Matéria:</label>
                        <input type="text" id="materia" name="materia" required list="materias-datalist"
                                class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <datalist id="materias-datalist"></datalist>
                    </div>
                    <div>
                        <label for="assunto" class="block text-sm font-medium text-gray-700 mb-1">Assunto:</label>
                        <input type="text" id="assunto" name="assunto" required list="assuntos-datalist"
                                class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <datalist id="assuntos-datalist"></datalist>
                    </div>
                    <div>
                        <label for="data" class="block text-sm font-medium text-gray-700 mb-1">Data:</label>
                        <input type="date" id="data" name="data" required
                                class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="quantidadeFeita" class="block text-sm font-medium text-gray-700 mb-1">Quantidade Feita:</label>
                        <input type="number" id="quantidadeFeita" name="quantidadeFeita" min="0" required
                                class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="quantidadeAcertada" class="block text-sm font-medium text-gray-700 mb-1">Quantidade Acertada:</label>
                        <input type="number" id="quantidadeAcertada" name="quantidadeAcertada" min="0" required
                                class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <button type="submit"
                                         class="form-button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                        Registrar
                    </button>
                </form>
            </div>
            <div class="lg:col-span-2 card">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Registros Recentes</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Matéria</th>
                                <th class="py-3 px-6 text-left">Assunto</th>
                                <th class="py-3 px-6 text-left">Data</th>
                                <th class="py-3 px-6 text-left">Feitas</th>
                                <th class="py-3 px-6 text-left">Acertadas</th>
                                <th class="py-3 px-6 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="records-table-body" class="text-gray-700 text-sm font-light">
                            <tr><td colspan="6" class="py-3 px-6 text-center">Nenhum registro para exibir.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="desempenho-section" class="hidden lg:col-span-2 card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Seu Desempenho</h2>
                <button id="open-settings-modal" class="form-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Configurações
                </button>
            </div>

            <div id="performance-summary" class="mb-8">
                <p class="text-gray-600">Carregando dados de desempenho...</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="chart-container lg:col-span-1" id="overallAccuracyChartContainer">
                    <canvas id="overallAccuracyChart"></canvas>
                </div>
                <div class="chart-container lg:col-span-1" id="materiaAccuracyChartContainer">
                    <canvas id="materiaAccuracyChart"></canvas>
                </div>
                <div class="chart-container lg:col-span-1" id="assuntoAccuracyChartContainer">
                    <canvas id="assuntoAccuracyChart"></canvas>
                </div>
                <div class="chart-container lg:col-span-3" id="assuntoTrendChartContainer">
                    <canvas id="assuntoTrendChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="revisoes-section" class="hidden lg:col-span-2 card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Próximas Revisões</h2>
                <button id="open-revision-settings" class="form-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Ajustar Variáveis
                </button>
            </div>
            
            <div class="mb-6 p-4 rounded-lg shadow-inner bg-gray-50">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Resumo das Revisões</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="p-4 bg-red-100 text-red-800 rounded-lg shadow">
                        <p class="text-sm font-medium">Em Atraso</p>
                        <p id="summary-late" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg shadow">
                        <p class="text-sm font-medium">Hoje</p>
                        <p id="summary-today" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-blue-100 text-blue-800 rounded-lg shadow">
                        <p class="text-sm font-medium">Próximas</p>
                        <p id="summary-upcoming" class="text-3xl font-bold">0</p>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Revisões Em Atraso</h3>
                <div id="late-revisions-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-gray-600 text-sm">Nenhuma revisão em atraso. Ótimo trabalho!</p>
                </div>
            </div>


            <div class="overflow-x-auto">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Todas as Revisões Agendadas</h3>
                <table class="min-w-full bg-white rounded-lg shadow-md">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Matéria</th>
                            <th class="py-3 px-6 text-left">Assunto</th>
                            <th class="py-3 px-6 text-left">Última Revisão</th>
                            <th class="py-3 px-6 text-left">Próxima Revisão</th>
                            <th class="py-3 px-6 text-left">Precisão Histórica</th>
                            <th class="py-3 px-6 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="revisions-table-body" class="text-gray-700 text-sm font-light">
                        <tr><td colspan="6" class="py-3 px-6 text-center">Nenhuma revisão agendada.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-4 text-center text-sm rounded-t-xl mt-8">
        <div class="container">
            © 2025 Registro de Questões. Todos os direitos reservados.
        </div>
    </footer>

    <!-- MODAL DE DOAÇÕES -->
    <div id="donation-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-2xl">
            <button onclick="closeDonationModal()" class="close-button">&times;</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">❤️ Apoie o Projeto</h2>
            <p class="text-gray-600 mb-6 text-center">Sua doação ajuda a manter esta ferramenta viva e em constante melhoria. Obrigado pelo apoio!</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <!-- PIX -->
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">PIX</h3>
                    <p class="text-sm text-gray-500 mb-2">Chave aleatória:</p>
                    <div class="flex items-center space-x-2 mb-4">
                        <input type="text" id="pix-key" value="00000000-0000-0000-0000-000000000000" readonly class="flex-grow px-2 py-1 text-sm bg-white border border-gray-300 rounded-md shadow-sm">
                        <button onclick="copyToClipboard('pix-key')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg shadow-md text-sm">
                            Copiar
                        </button>
                    </div>
                    <div class="flex justify-center">
                        <!-- Placeholder for a PIX QR Code -->
                        <img src="https://placehold.co/150x150/e2e8f0/0f172a?text=QR+Code+PIX" alt="QR Code PIX" class="rounded-lg">
                    </div>
                </div>

                <!-- Criptomoedas -->
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 space-y-4">
                    <h3 class="text-lg font-bold text-gray-800">Criptomoedas</h3>
                    <!-- BTC -->
                    <div>
                        <p class="font-medium text-gray-700 mb-1">Bitcoin (BTC)</p>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="btc-address" value="bc1qabcdefghijklmnopqrstuvwxyz0123456789" readonly class="flex-grow px-2 py-1 text-sm bg-white border border-gray-300 rounded-md shadow-sm">
                            <button onclick="copyToClipboard('btc-address')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg shadow-md text-sm">
                                Copiar
                            </button>
                        </div>
                    </div>
                    <!-- Monero -->
                    <div>
                        <p class="font-medium text-gray-700 mb-1">Monero (XMR)</p>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="xmr-address" value="44tLgQ459v7v9jY6J4z8aA3N92Z5g7G6cW5g7G6cW5g7G6cW5g7G6cW5g7G6c" readonly class="flex-grow px-2 py-1 text-sm bg-white border border-gray-300 rounded-md shadow-sm">
                            <button onclick="copyToClipboard('xmr-address')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg shadow-md text-sm">
                                Copiar
                            </button>
                        </div>
                    </div>
                    <!-- Cardano -->
                    <div>
                        <p class="font-medium text-gray-700 mb-1">Cardano (ADA)</p>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="ada-address" value="addr1q9abcdefghijklmnopqrstuvwxyza0123456789" readonly class="flex-grow px-2 py-1 text-sm bg-white border border-gray-300 rounded-md shadow-sm">
                            <button onclick="copyToClipboard('ada-address')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg shadow-md text-sm">
                                Copiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- FIM DA MODAL DE DOAÇÕES -->

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="close-settings-modal" class="close-button">&times;</button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Configurações de Desempenho</h2>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Exportar / Importar Dados</h3>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 justify-end">
                    <button id="export-csv-button" class="form-button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                        Exportar para CSV
                    </button>
                    <button id="import-csv-button" class="form-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                        Importar CSV
                    </button>
                    <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                </div>
            </div>

            <hr class="my-6 border-gray-200">

            <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Filtros de Dados</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="materia-filter" class="block text-sm font-medium text-gray-700 mb-1">Matéria:</label>
                        <select id="materia-filter" class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="todos">Todas as Matérias</option>
                            </select>
                    </div>
                    <div>
                        <label for="assunto-filter" class="block text-sm font-medium text-gray-700 mb-1">Assunto:</label>
                        <select id="assunto-filter" class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="todos">Todos os Assuntos</option>
                            </select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 col-span-full">
                        <label class="block text-sm font-medium text-gray-700 mb-1 col-span-full">Filtrar por Data:</label>
                        <input type="date" id="start-date-filter" class="form-input px-2 py-1 border border-gray-300 rounded-md text-sm w-full">
                        <input type="date" id="end-date-filter" class="form-input px-2 py-1 border border-gray-300 rounded-md text-sm w-full">
                        <button id="reset-date-filter" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-2 rounded-md text-sm w-full">
                            Limpar Filtro de Data
                        </button>
                    </div>
                    <div class="col-span-full">
                        <label for="accuracy-threshold-input" class="block text-sm font-medium text-gray-700 mb-1">Limite de Precisão para Melhorar (%):</label>
                        <input type="number" id="accuracy-threshold-input" value="70" min="0" max="100"
                                class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                </div>
            </div>

            <hr class="my-6 border-gray-200">

            <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Opções de Visualização</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="display-options-container">
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                        <input type="checkbox" id="showOverallSummary" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-3 text-gray-800 font-medium">Resumo Geral</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                        <input type="checkbox" id="showOverallAccuracyChart" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-3 text-gray-800 font-medium">Gráfico Geral de Precisão</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                        <input type="checkbox" id="showMateriaAccuracyChart" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-3 text-gray-800 font-medium">Gráfico de Precisão por Matéria</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                        <input type="checkbox" id="showAssuntoAccuracyChart" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-3 text-gray-800 font-medium">Gráfico de Precisão por Assunto</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                        <input type="checkbox" id="showTrendChart" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-3 text-gray-800 font-medium">Gráfico de Evolução (Tendência)</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                        <input type="checkbox" id="showImprovementAreas" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-3 text-gray-800 font-medium">Áreas para Melhorar</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                        <input type="checkbox" id="showAssuntoRevisions" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-3 text-gray-800 font-medium">Revisões por Assunto (Matéria Filtrada)</span>
                    </label>
                </div>
            </div>

            <hr class="my-6 border-gray-200">

            <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Comparar Evolução (Gráfico de Tendência)</h3>
                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="compare-type" value="none" class="form-radio h-4 w-4 text-blue-600" checked>
                        <span class="ml-2 text-gray-700">Nenhuma Comparação</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="compare-type" value="materia" class="form-radio h-4 w-4 text-blue-600">
                        <span class="ml-2 text-gray-700">Comparar Matérias</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="compare-type" value="assunto" class="form-radio h-4 w-4 text-blue-600">
                        <span class="ml-2 text-gray-700">Comparar Assuntos</span>
                    </label>
                </div>

                <div id="comparison-buttons-container" class="flex flex-wrap gap-2 hidden">
                    </div>

                <div class="mt-4 p-3 bg-yellow-50 rounded-lg text-yellow-800 text-sm">
                    <p class="font-semibold mb-1">Dica de Comparação:</p>
                    <p>Selecione os itens acima para ver a evolução da precisão de cada um no gráfico de tendência. Você pode sobrepor a meta de acertos (linha pontilhada) no gráfico de evolução para ver se está atingindo seus objetivos.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="revision-settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="close-revision-settings" class="close-button">&times;</button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Ajustar Variáveis de Revisão</h2>
            
            <p class="text-sm text-gray-600 mb-4">Ajuste os intervalos de dias para agendamento de revisões, com base na porcentagem de acertos. O botão "Reset" será exibido em tempo real quando você fizer uma alteração.</p>
            
            <div class="space-y-4" id="revision-intervals-container">
                </div>

            <div class="p-4 bg-gray-50 rounded-lg mt-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Como Funciona o Agendamento de Revisões</h3>
                <p class="text-sm text-gray-600 mb-2">O sistema calcula a próxima data de revisão com base na sua <strong>precisão histórica acumulada</strong> para cada assunto. Dependendo da porcentagem de acertos, um intervalo de dias é escolhido aleatoriamente dentro da faixa que você definir abaixo. Por exemplo, se sua precisão estiver entre 70% e 80%, a próxima revisão será agendada para daqui a 30 a 60 dias.</p>
                <p class="text-sm text-gray-600">Isso ajuda a espaçar as revisões de forma inteligente, focando mais nos assuntos com menor desempenho e reforçando aqueles com bom desempenho em intervalos mais longos.</p>
                <hr class="my-3 border-gray-300">
                <p class="text-xs text-blue-700 font-medium">📌 Recomenda-se realizar pelo menos 15 questões no dia da revisão, para garantir que a análise de desempenho seja representativa e o espaçamento continue adequado.</p>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="close-edit-modal" class="close-button">&times;</button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Editar Registro</h2>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-record-id">
                <div>
                    <label for="edit-materia" class="block text-sm font-medium text-gray-700 mb-1">Matéria:</label>
                    <input type="text" id="edit-materia" name="materia" required
                            class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="edit-assunto" class="block text-sm font-medium text-gray-700 mb-1">Assunto:</label>
                    <input type="text" id="edit-assunto" name="assunto" required
                            class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="edit-data" class="block text-sm font-medium text-gray-700 mb-1">Data:</label>
                    <input type="date" id="edit-data" name="data" required
                            class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="edit-quantidadeFeita" class="block text-sm font-medium text-gray-700 mb-1">Quantidade Feita:</label>
                    <input type="number" id="edit-quantidadeFeita" name="quantidadeFeita" min="0" required
                            class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="edit-quantidadeAcertada" class="block text-sm font-medium text-gray-700 mb-1">Quantidade Acertada:</label>
                    <input type="number" id="edit-quantidadeAcertada" name="quantidadeAcertada" min="0" required
                            class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <button type="submit"
                                         class="form-button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Salvar Alterações
                </button>
            </form>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <p id="confirmation-message" class="text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes" class="form-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Sim
                </button>
                <button id="confirm-no" class="form-button bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md">
                    Não
                </button>
            </div>
        </div>
    </div>
    
    <div id="complete-revision-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-sm">
            <button id="close-complete-revision-modal" onclick="closeCompleteRevisionModal()" class="close-button">&times;</button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Concluir Revisão</h2>
            <p class="text-sm text-gray-600 mb-4">Insira os resultados da sua revisão para <span id="revision-subject-name" class="font-bold text-blue-700"></span>.</p>
            <form id="complete-revision-form" class="space-y-4">
                <input type="hidden" id="complete-revision-id">
                <div>
                    <label for="revision-quantidadeFeita" class="block text-sm font-medium text-gray-700 mb-1">Quantidade Feita:</label>
                    <input type="number" id="revision-quantidadeFeita" name="quantidadeFeita" min="0" required
                            class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="revision-quantidadeAcertada" class="block text-sm font-medium text-gray-700 mb-1">Quantidade Acertada:</label>
                    <input type="number" id="revision-quantidadeAcertada" name="quantidadeAcertada" min="0" required
                            class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <button type="submit"
                                         class="form-button w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Registrar Revisão
                </button>
            </form>
        </div>
    </div>
    
    <div id="reschedule-revision-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-sm">
            <button id="close-reschedule-revision-modal" onclick="closeRescheduleRevisionModal()" class="close-button">&times;</button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Reagendar Revisão</h2>
            <p class="text-sm text-gray-600 mb-4">Escolha uma nova data para a revisão de <span id="reschedule-subject-name" class="font-bold text-blue-700"></span>.</p>
            <form id="reschedule-form" class="space-y-4">
                <input type="hidden" id="reschedule-revision-id">
                <div>
                    <label for="reschedule-date" class="block text-sm font-medium text-gray-700 mb-1">Nova Data:</label>
                    <input type="date" id="reschedule-date" name="newDate" required
                            class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <button type="submit"
                                         class="form-button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Confirmar Reagendamento
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL DE CONTATOS -->
    <div id="contact-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-md text-center">
            <button onclick="closeContactModal()" class="close-button">&times;</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Fale Conosco</h2>
            <p class="text-gray-600 mb-6">Estamos aqui para ajudar com suas dúvidas e sugestões!</p>
            
            <div class="space-y-4 text-left">
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="font-bold text-gray-800">Instagram</h3>
                    <p class="text-gray-600 break-words">Siga-me para atualizações e mais dicas de estudo.</p>
                    <a href="https://www.instagram.com/meu_instagram" target="_blank" class="text-blue-600 hover:underline">@meu_instagram</a>
                </div>
                
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="font-bold text-gray-800">E-mail</h3>
                    <p class="text-gray-600 break-words">Envie-nos um e-mail para qualquer questão ou feedback.</p>
                    <a href="mailto:meu.email@example.com" class="text-blue-600 hover:underline">meu.email@example.com</a>
                </div>
            </div>
        </div>
    </div>
    <!-- FIM DA MODAL DE CONTATOS -->

    <!-- MODAL SOBRE O PROJETO -->
    <div id="about-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button onclick="closeAboutModal()" class="close-button">&times;</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Sobre o Projeto e o Desenvolvedor</h2>
            
            <div class="space-y-6 text-gray-700">
                <div class="p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="flex items-center text-xl font-semibold text-gray-800 mb-2">
                        <svg class="h-6 w-6 text-blue-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Quem sou eu e o que faço
                    </h3>
                    <p>Olá! Sou um desenvolvedor apaixonado por tecnologia e por criar soluções que realmente façam a diferença na vida das pessoas. Este aplicativo foi concebido e construído por mim com um único objetivo em mente: ajudar estudantes e concurseiros a otimizar seus estudos de forma inteligente e eficiente, sem nenhum custo.</p>
                </div>

                <div class="p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="flex items-center text-xl font-semibold text-gray-800 mb-2">
                        <svg class="h-6 w-6 text-green-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.253" />
                        </svg>
                        O Motivo Filantrópico
                    </h3>
                    <p>O desenvolvimento desta ferramenta é um projeto filantrópico. Acredito que o acesso a ferramentas de estudo de qualidade não deve ser limitado por barreiras financeiras. Por isso, decidi disponibilizar este aplicativo de forma totalmente gratuita. Meu objetivo é democratizar o acesso a métodos de estudo que podem aumentar a produtividade e a chance de sucesso em provas e concursos.</p>
                </div>
                
                <div class="p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="flex items-center text-xl font-semibold text-gray-800 mb-2">
                        <svg class="h-6 w-6 text-purple-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                        A Importância da Doação
                    </h3>
                    <p>Embora o aplicativo seja gratuito, a sua manutenção, hospedagem e futuras atualizações têm custos. Se esta ferramenta foi útil para você, considere fazer uma doação. Não importa o valor, cada centavo é um incentivo para que eu continue trabalhando neste projeto, melhorando-o e adicionando novas funcionalidades para a comunidade. Sua doação é um investimento direto na educação e no desenvolvimento de uma ferramenta acessível a todos. Agradeço imensamente o seu apoio!</p>
                </div>

                <div class="p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="flex items-center text-xl font-semibold text-gray-800 mb-2">
                        <svg class="h-6 w-6 text-yellow-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Guia de Utilização do Aplicativo
                    </h3>
                    <p class="font-bold">Para começar, o aplicativo funciona em 3 seções principais:</p>
                    
                    <div class="space-y-4 mt-4">
                        <div class="p-4 bg-white rounded-lg shadow-inner border border-gray-100">
                            <h4 class="text-lg font-semibold text-gray-800">1. Seção de Registro</h4>
                            <p class="mt-2 text-sm text-gray-600">É a página inicial onde você registrará o seu desempenho. Para cada bloco de questões que você fizer:</p>
                            <ul class="list-disc list-inside space-y-1 mt-2 text-sm text-gray-600">
                                <li>Preencha os campos de <strong>Matéria</strong> e <strong>Assunto</strong> (o aplicativo oferece sugestões com base nos seus registros anteriores).</li>
                                <li>Coloque a <strong>Data</strong> em que a atividade foi realizada.</li>
                                <li>Informe a <strong>Quantidade Feita</strong> de questões e a <strong>Quantidade Acertada</strong>.</li>
                                <li>Clique em <strong>"Registrar"</strong>. O aplicativo salvará seus dados localmente no navegador.</li>
                            </ul>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow-inner border border-gray-100">
                            <h4 class="text-lg font-semibold text-gray-800">2. Seção de Desempenho</h4>
                            <p class="mt-2 text-sm text-gray-600">Aqui, você pode visualizar seu progresso.</p>
                            <ul class="list-disc list-inside space-y-1 mt-2 text-sm text-gray-600">
                                <li>O <strong>Resumo Geral</strong> mostra a sua performance total.</li>
                                <li>Os gráficos exibem a sua precisão por matéria e assunto, além da evolução ao longo do tempo.</li>
                                <li>Na área <strong>"Áreas para Melhorar"</strong>, o aplicativo lista automaticamente os assuntos onde sua precisão está abaixo da meta (70%, mas você pode ajustar isso nas configurações).</li>
                                <li>Em <strong>Configurações</strong>, você pode ajustar filtros, esconder ou mostrar gráficos e até mesmo exportar seus dados para um arquivo CSV para manter um backup pessoal.</li>
                            </ul>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow-inner border border-gray-100">
                            <h4 class="text-lg font-semibold text-gray-800">3. Seção de Revisões</h4>
                            <p class="mt-2 text-sm text-gray-600">Esta é a seção mais importante para a revisão espaçada.</p>
                            <ul class="list-disc list-inside space-y-1 mt-2 text-sm text-gray-600">
                                <li>Com base no seu desempenho registrado, o aplicativo agenda automaticamente as próximas revisões.</li>
                                <li>Assuntos com baixa precisão terão revisões mais frequentes, enquanto aqueles com alta precisão terão intervalos mais longos.</li>
                                <li>As revisões são classificadas como "Em Atraso", "Hoje" ou "Próximas", ajudando a priorizar.</li>
                                <li>Quando você conclui uma revisão, basta clicar em <strong>"Concluir"</strong> e registrar seu novo desempenho para que o aplicativo recalcule o próximo agendamento.</li>
                                <li>Ajuste os intervalos de revisão em <strong>"Ajustar Variáveis"</strong> para personalizar a frequência de acordo com sua necessidade.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <p class="text-sm text-gray-600">Lembre-se: Para que o sistema funcione corretamente, é fundamental que você <strong>registre seus dados com frequência</strong> e <strong>realize as revisões agendadas</strong>. Aproveite a ferramenta e bons estudos!</p>
            </div>
        </div>
    </div>
    <!-- FIM DA MODAL SOBRE O PROJETO -->

    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <p id="confirmation-message" class="text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes" class="form-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Sim
                </button>
                <button id="confirm-no" class="form-button bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md">
                    Não
                </button>
            </div>
        </div>
    </div>
    
    <div id="complete-revision-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-sm">
            <button id="close-complete-revision-modal" onclick="closeCompleteRevisionModal()" class="close-button">&times;</button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Concluir Revisão</h2>
            <p class="text-sm text-gray-600 mb-4">Insira os resultados da sua revisão para <span id="revision-subject-name" class="font-bold text-blue-700"></span>.</p>
            <form id="complete-revision-form" class="space-y-4">
                <input type="hidden" id="complete-revision-id">
                <div>
                    <label for="revision-quantidadeFeita" class="block text-sm font-medium text-gray-700 mb-1">Quantidade Feita:</label>
                    <input type="number" id="revision-quantidadeFeita" name="quantidadeFeita" min="0" required
                            class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="revision-quantidadeAcertada" class="block text-sm font-medium text-gray-700 mb-1">Quantidade Acertada:</label>
                    <input type="number" id="revision-quantidadeAcertada" name="quantidadeAcertada" min="0" required
                            class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <button type="submit"
                                         class="form-button w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Registrar Revisão
                </button>
            </form>
        </div>
    </div>
    
    <div id="reschedule-revision-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-sm">
            <button id="close-reschedule-revision-modal" onclick="closeRescheduleRevisionModal()" class="close-button">&times;</button>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Reagendar Revisão</h2>
            <p class="text-sm text-gray-600 mb-4">Escolha uma nova data para a revisão de <span id="reschedule-subject-name" class="font-bold text-blue-700"></span>.</p>
            <form id="reschedule-form" class="space-y-4">
                <input type="hidden" id="reschedule-revision-id">
                <div>
                    <label for="reschedule-date" class="block text-sm font-medium text-gray-700 mb-1">Nova Data:</label>
                    <input type="date" id="reschedule-date" name="newDate" required
                            class="form-input mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <button type="submit"
                                         class="form-button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    Confirmar Reagendamento
                </button>
            </form>
        </div>
    </div>
</body>
</html>
